# Claude Code トークン消費削減施策の調査結果

## 概要
本ドキュメントは、Claude Code のトークン消費量を抑えるための施策を調査し、現在のマルチエージェント構成に適用できる対策をまとめたものである。

## 1. 一般的なトークン削減対策

### 1.1 モデル選択の最適化
**概要**: タスクの複雑さに応じて適切なモデルを選択する。

**具体的な施策**:
- **Haiku の活用**: シンプルなタスクには Haiku を使用（Sonnet より 70-80% 安い）
- **Sonnet の適用**: 一般的なコーディングタスクに使用
- **Opus の限定的使用**: 複雑なアーキテクチャ決定や多段階推論にのみ使用

**効果**: タスクの 30-40% を Haiku に移行することで、全体のコスト削減が期待できる。

### 1.2 コンテキスト管理
**概要**: 不要なコンテキストを削除し、必要な情報のみを保持する。

**具体的な施策**:
- **`/clear` コマンドの活用**: 無関係な作業に切り替える際に、古いコンテキストをクリア
- **`/compact` コマンドの活用**: 会話履歴を圧縮形式に要約
- **定期的なセッションリセット**: 長時間の作業後、不要なコンテキストを削除

**効果**: 50-70% のトークン削減が期待できる。

### 1.3 CLAUDE.md の最適化
**概要**: プロジェクト指示書を最適化し、不要な情報を削除する。

**具体的な施策**:
- **読み取り対象の明示**: Claude が読むべきファイルを明示的に指定
- **禁止ディレクトリの指定**: 不要なディレクトリへのアクセスを禁止
- **簡潔な指示**: 冗長な説明を削除し、明確で簡潔な指示にする

**効果**: フォーカスを絞り、不要なファイル読み取りを防ぐ。

### 1.4 .claudeignore の活用
**概要**: Claude が無視すべきファイルやディレクトリを指定する。

**具体的な施策**:
- **node_modules の除外**: 依存関係ディレクトリを無視
- **ビルド成果物の除外**: dist/, build/ などを無視
- **テンポラリファイルの除外**: .tmp, .cache などを無視

**効果**: 50-90% のトークン削減が期待できる（特に大規模プロジェクト）。

### 1.5 MCP サーバー管理
**概要**: 不要な MCP サーバーを無効化し、システムプロンプトのサイズを削減する。

**具体的な施策**:
- **`/context` コマンドの活用**: MCP サーバーの消費量を確認
- **未使用サーバーの無効化**: 現在のタスクに不要なサーバーを無効化

**効果**: システムプロンプトのサイズ削減。

### 1.6 高度な最適化: qmd
**概要**: ローカルドキュメントインデクサー（qmd）を使用し、コードベース検索を効率化する。

**具体的な施策**:
- **qmd のセットアップ**: コードベースのインデックスを作成
- **MCP サーバーとして公開**: Claude に検索エンジンとして提供
- **手動ファイル読み取りの削減**: インデックス検索で必要なファイルのみを読み取り

**効果**: 大規模コードベースでの大幅な効率化。

## 2. マルチエージェント構成への適用

### 2.1 現在の構成の課題
- **複数セッションの並行実行**: おじいさん、桃太郎、お供3人の計5セッション
- **重複するコンテキスト**: 各エージェントが同じプロジェクト指示書を読み込む
- **agent-send.sh によるメッセージ送信**: メッセージの履歴が各セッションに蓄積
- **長い指示書**: CLAUDE.md、各役割の指示書が詳細

### 2.2 適用可能な施策

#### 優先度: 高

**施策 1: 指示書の簡潔化**
- **対象**: CLAUDE.md, ojiisan.md, momotarou.md, otomo.md
- **内容**:
  - 冗長な説明を削除
  - 例示を最小限に
  - 重複する内容を統合
- **効果**: 各エージェントの初期コンテキストサイズを削減（推定 20-30%）
- **実装難易度**: 低

**施策 2: .claudeignore の導入**
- **対象**: プロジェクトルート
- **内容**:
  ```
  node_modules/
  .git/
  */worktree-*/
  *.log
  .DS_Store
  ```
- **効果**: 不要なファイルの読み取りを防止（推定 30-50%）
- **実装難易度**: 低

**施策 3: メッセージの簡潔化**
- **対象**: agent-send.sh を使った通信
- **内容**:
  - 不要な挨拶や定型文を削減
  - 必要な情報のみを送信
  - 長文の場合は要約を優先
- **効果**: メッセージ履歴のサイズ削減（推定 10-20%）
- **実装難易度**: 低

#### 優先度: 中

**施策 4: 定期的なコンテキストクリア**
- **対象**: 全エージェント
- **内容**:
  - 作業完了後に `/compact` を実行
  - 無関係な作業への切り替え時に `/clear` を実行
  - おじいさんが定期的にクリア指示を出す
- **効果**: 長時間セッションでのトークン削減（推定 30-50%）
- **実装難易度**: 中（運用ルールの確立が必要）

**施策 5: モデル選択の最適化**
- **対象**: お供（シンプルなタスク担当）
- **内容**:
  - シンプルな修正作業には Haiku を使用
  - 複雑なタスクには Sonnet を使用
  - 桃太郎が適切なモデルを指定
- **効果**: お供の作業コスト削減（推定 30-40%）
- **実装難易度**: 中（タスクの複雑さ判断が必要）

**施策 6: 役割の明確化と重複削減**
- **対象**: 全エージェント
- **内容**:
  - 各エージェントの責任範囲を明確化
  - 重複する作業を削減
  - 情報の中継を最小限に
- **効果**: 不要な作業と通信の削減（推定 10-20%）
- **実装難易度**: 中（役割の再定義が必要）

#### 優先度: 低

**施策 7: qmd の導入**
- **対象**: プロジェクト全体
- **内容**:
  - qmd をセットアップし、コードベースのインデックスを作成
  - MCP サーバーとして公開
  - お供がファイル検索時に活用
- **効果**: 大規模な検索タスクでのトークン削減
- **実装難易度**: 高（新しいツールの導入と設定が必要）

**施策 8: MCP サーバーの選択的無効化**
- **対象**: 全エージェント
- **内容**:
  - タスクに応じて不要な MCP サーバーを無効化
  - おじいさんが作業開始時に指定
- **効果**: システムプロンプトのサイズ削減（推定 5-10%）
- **実装難易度**: 中（どのサーバーが必要かの判断が必要）

## 3. 推奨実装順序

### フェーズ 1: 即座に実装可能（推定削減: 40-60%）
1. .claudeignore の導入
2. 指示書の簡潔化
3. メッセージの簡潔化

### フェーズ 2: 運用ルール確立（推定削減: 追加 20-30%）
4. 定期的なコンテキストクリア
5. 役割の明確化と重複削減

### フェーズ 3: 高度な最適化（推定削減: 追加 10-20%）
6. モデル選択の最適化
7. MCP サーバーの選択的無効化
8. qmd の導入（オプション）

## 4. 効果見積もり

### 総合的な削減効果
- **フェーズ 1 実装後**: 40-60% のトークン削減
- **フェーズ 2 実装後**: 60-90% のトークン削減
- **フェーズ 3 実装後**: 70-95% のトークン削減（最大）

### 実装の容易さ
- **簡単**: .claudeignore、指示書の簡潔化、メッセージの簡潔化
- **中程度**: コンテキストクリア、モデル選択、役割の明確化
- **困難**: qmd の導入

## 5. 参考資料

### 調査に使用した情報源
- [Manage costs effectively - Claude Code Docs](https://code.claude.com/docs/en/costs)
- [How to optimize Claude Code token usage - ClaudeLog](https://claudelog.com/faqs/how-to-optimize-claude-code-token-usage/)
- [Claude Code Pricing: Optimize Your Token Usage & Costs](https://claudefa.st/blog/guide/development/usage-optimization)
- [Claude Code Token Limits - Faros AI](https://www.faros.ai/blog/claude-code-token-limits)
- [Stop Wasting Tokens: How to Optimize Claude Code Context by 60%](https://medium.com/@jpranav97/stop-wasting-tokens-how-to-optimize-claude-code-context-by-60-bfad6fd477e5)
- [How to Reduce Claude Code Costs: Complete Guide 2026](https://www.thecaio.ai/blog/reduce-claude-code-costs)
- [You're using Claude Code wrong. Here's How To save 95% of tokens.](https://medium.com/@simonsruggi/youre-using-claude-code-wrong-here-s-how-to-save-95-of-tokens-db6114c1f4d6)
- [Claude Code Token Management 2026](https://richardporter.dev/blog/claude-code-token-management)

## 6. 結論

本調査により、Claude Code のトークン消費を大幅に削減できる多くの施策が見つかった。特に、.claudeignore の導入、指示書の簡潔化、メッセージの簡潔化は、実装が容易で効果が高いため、即座に実装すべきである。

現在のマルチエージェント構成では、複数セッションが並行して動作するため、各セッションでのトークン削減が全体に大きな影響を与える。フェーズ 1 の施策を実装するだけで、40-60% のトークン削減が期待でき、運用コストの大幅な削減につながる。

さらに、フェーズ 2 以降の施策を実装することで、最大 70-95% のトークン削減が可能となり、長期的な運用コストの最適化が実現できる。
